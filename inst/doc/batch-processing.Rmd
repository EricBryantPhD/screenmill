---
title: "ScreenMill batch processing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{ScreenMill batch processing}
  \usepackage[utf8]{inputenc}
---

# Introduction

This vignette describes how to process a batch of solid agar colony growth measurement screens that have been quantified and reviewed using [ScreenMill]'s colony measurement, and data review engines. Processing requires two steps:

1. Recording metadata for the screen (e.g. incubation times)
2. Generating fully cleaned/annotated raw data and metadata for inclusion in the rothscreen database.

# Recording metadata

First create **screens.csv** and **plates.csv** metadata tables by executing the following command. The colony measurement log file is used to generate all combinations of scan names, scan conditions, and plate numbers. If necessary, also create a custom strain collection keyfile.

```{r eval = FALSE}
# Write `plates.csv` and `screens.csv` to the same directory as `cm.txt`
screenmill::new_batch_metadata('path/to/cm.txt')
# If necessary, create a new strain collection keyfile
# screenmill::new_strain_collection(id = 'collection_id', nplates = 2, density = 96)
```

In **plates.csv** fill out necessary values for each column:

- **scan_name**: Do not edit.
- **scan_condition**: Do not edit.
- **plate**: Do not edit.
- **incubation_start**: When incubation began in YYYY-MM-DD HH:MM:SS TZ format.
  (i.e. the result of `Sys.time()`: `r Sys.time()`).
- **incubation_end**: When the plate was scanned in YYYY-MM-DD HH:MM:SS TZ format.

In **screens.csv** fill out necessary values for each column:

- **screen_id**: Give all screens in a time series the same `screen_id`. The 
  format YYYY-MM-DD-condition-query works well as a standard ID string. 
- **scan_name**: Do not edit.
- **scan_condition**: Do not edit.
- **screen_name**: A short descriptive name of the screen.
- **screen_description**: A long description of the screen.
- **analysis_id**: This should match an ID in the `analyses` table.
- **strain_collection_id**: This should match an ID in the `strain_collections` 
  table of the rothscreen database or the ID used in your custom keyfile.
- **query_type**: Either `plasmid`, `drug`, or `strain`.
- **query_id**: A `plasmid_id`, `drug_id`, or `strain_id`.
- **query_name**: A short query name (e.g. GAL1p-CTF4)
- **control_screen_id**: The `screen_id` of the corresponding control query.
- **method_id**: An expermimental method ID (e.g. SPA, SGA)
- **media_id**: A growth media ID.
- **timepoint**: An integer specifying the timepoint (0 for a scan before 
  incubation).
- **temperature**: Incubation temperature in Celcius.
- **screen_owner**: Name - email
- **screen_notes**: miscellaneous notes about this screen.

# Prepare data for inclusion in database

1. Create a new Rmarkdown document with the following code chunk.
2. Modify settings as needed.
3. Render the document.
4. Copy all files in resulting `db` folder to `rothscreen/inst/db/screens/`
5. Commit the added files and push updates to the repository

```{r eval = FALSE}
## ---- Settings: -------------------------------------------------------------
date       <- 'YYYY-MM-DD' # prepended to file name
replicates <- 4            # number of replicates of each strain
cm         <- 'path/to/cm-engine-log.txt'
dr         <- 'path/to/dr-engine-all-stats.txt'
aux        <- 'path/to/dr-engine-auxilliary-stats.txt'
screens    <- 'path/to/screens-metadata.csv'
plates     <- 'path/to/plates-metadata.csv'
custom_strain_collection = FALSE # or, 'path/to/strain-collection.csv'
## ----------------------------------------------------------------------------

# Load required packagaes and connect to the database
library(screenmill); library(rothscreen); library(dplyr)
db <- src_rothscreen()

# Read in all required data
measurements <- read_cm(cm, replicates = replicates)
metadata     <- read_metadata(screens, plates)
exclusions   <- bind_rows(read_dr(dr), read_dr(aux))
strains      <- db %>% tbl('strains') %>% select(strain_id, strain_name) %>% collect
if (custom_strain_collection) {
  collection <- read.csv(custom_strain_collection, stringsAsFactors = F)
} else {
  collection <- db %>% tbl('strain_collections') %>% collect
}

# Annotate measurements with node/edge IDs, incubation time, and exlusion data
raw_colony_sizes <- 
  measurements %>%
  left_join(metadata) %>%
  left_join(exclusions) %>%
  left_join(collection) %>%
  left_join(strains) %>%
  select(
    # Identification
    screen_id, strain_id, strain_name, query_id, query_name, 
    plate, row, column, replicate,
    # Measurements
    size, size_dr, circ,
    # Incubation time
    timepoint, incubation, incubation_start, incubation_end,
    # Exclusions and controls
    excluded_query, excluded_control, plate_control
  )

# Write data to disk
name           <- paste('db', date, sep = '/')
name_raw_sizes <- paste0(name, '-raw-colony-sizes.csv')
name_screens   <- paste0(name, '-screens.csv')
write.csv(raw_colony_sizes, name_raw_sizes, row.names = FALSE)
file.copy(screens, name_screens, overwrite = TRUE)
if (custom_strain_collection) {
  name_collection <- paste0('db/', basename(custom_strain_collection))
  file.copy(custom_strain_collection, name_collection, overwrite = TRUE)
}

# Record session information
devtools::session_info()
```

<!-- Links -->
[ScreenMill]: http://www.rothsteinlab.com/tools/screen_mill/cm_engine
